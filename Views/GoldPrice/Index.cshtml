@model IEnumerable<GoldPrice>

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Bảng giá vàng";
}
<div x-data="{
     selectedIds: [],

     GoldPriceId: 0,
     GoldTypeName: '' ,
     BuyPrice: 0 ,
     SellPrice: 0 ,
     IsBuyUpdating: false,
     IsSellUpdating: false,
     ModifiedDate: new Date().toISOString().substring(0,10),
     SortOrder: 1,
     submitted: false,
     isLoading: false,

        async openEditModal(id) {
            const res=await fetch(`@Url.Action("Get", "GoldPrice")/${id}`);
            const data = await res.json();

            this.GoldPriceID = id;
            this.GoldTypeName = data.goldTypeName;
            this.BuyPrice = data.buyPrice;
            this.SellPrice = data.sellPrice;
            this.IsBuyUpdating = data.isBuyUpdating;
            this.IsSellUpdating = data.isSellUpdating;
            this.SortOrder = data.sortOrder;
            new bootstrap.Modal(document.getElementById('addGoldTypeModal')).show();
        },

        async saveGoldType() {
            try{
                if (this.isLoading) return;
                this.submitted = true;

                if (!this.GoldTypeName) {
                    showToast('error', 'Vui lòng nhập loại vàng' );
                    return;
                }

                this.isLoading=true;
                    const res=await fetch('@Url.Action("post_create", "GoldPrice")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        GoldPriceID: this.GoldPriceID,
                        GoldTypeName: this.GoldTypeName,
                        BuyPrice: parseFloat(this.BuyPrice.replace( /,/g, '' )) || 0,
                        SellPrice: parseFloat(this.SellPrice.replace( /,/g, '' )) || 0,
                        IsBuyUpdating: this.IsBuyUpdating,
                        IsSellUpdating: this.IsSellUpdating,
                        SortOrder: this.SortOrder
                    })
                });

                if (res.ok) {
                    showToast('success', 'Lưu loại vàng thành công' );
                    const modalEl = document.getElementById('addGoldTypeModal');
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();
                    setTimeout(() => window.location.reload(), 1000);
                    //window.location.reload();
                } else {
                    const errText = await res.text();
                    showToast('error', err || 'Lưu thất bại' );
                }
            }
            catch(e){
                showToast('error', 'Lỗi kết nối server' );
            }
            finally {
                this.isLoading = false;
            }
        },

        async onDelete(){
            if (!confirm(`Bạn có chắc muốn xóa ${this.selectedIds.length} dòng?`))
                return;

            const res = await fetch('@Url.Action("delete", "GoldPrice")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.selectedIds)
            });

            if (res.ok) {
                alert('Xóa thành công');
                location.reload();
            } else {
                alert('Xóa thất bại');
            }
        },

        get isAllSelected() {
            return this.selectedIds.length === document.querySelectorAll('tbody input[type=checkbox]').length && this.selectedIds.length > 0;
        },

        toggleAll(event) {
            if (event.target.checked) {
                this.selectedIds = Array.from(document.querySelectorAll('tbody input[type=checkbox]')).map(cb => parseInt(cb.value));
            } else {
                this.selectedIds = [];
            }
        },
    }">
    <h2>Bảng giá vàng</h2>
    <p>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addGoldTypeModal">Thêm</button>
        <button class="btn btn-danger btn-sm" x-on:click="onDelete()">Xóa</button>
    </p>

    <table class="table table-striped">
        <thead>
            <tr>
                <th style="width:40px">
                    <input type="checkbox" x-on:change="toggleAll($event)" :checked="isAllSelected">
                </th>
                <th>Công ty</th>
                <th>Loại vàng</th>
                <th>Giá mua</th>
                <th>Giá bán</th>
                <th>Ngày</th>
                <th>Thứ tự</th>
                <th>Hiển thị</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var g in Model)
            {
                <tr>
                    <td><input type="checkbox" :value="@g.GoldPriceId" x-model="selectedIds"></td>
                    <td>@g.Company?.CompanyName</td>
                    <td>@g.GoldType?.GoldTypeName</td>
                    <td>@g.BuyPrice.ToString("N0")</td>
                    <td>@g.SellPrice.ToString("N0")</td>
                    <td>@g.ApplyDate.ToString("dd/MM/yyyy")</td>
                    <td>
                        <button class="btn btn-sm btn-warning" x-on:click="openEditModal(@g.GoldPriceId)">Sửa</button>
                    </td>
                    <td>@g.SortOrder</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Modal thêm loại vàng -->
    <div class="modal fade" id="addGoldTypeModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <!-- Loading overlay -->
                <div x-show="isLoading"
                     x-transition.opacity
                     class="loading-overlay">
                    <div class="spinner-border text-warning" style="width: 4rem; height: 4rem;"></div>
                    <div class="mt-3 fs-4 fw-bold text-warning">
                        Đang lưu dữ liệu...
                    </div>
                </div>
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Thêm loại vàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Loại vàng</label>
                        <input type="text" class="form-control" x-model.trim="GoldTypeName" :class="{ 'is-invalid': submitted && !GoldTypeName }" placeholder="VD: Vàng SJC 9999">
                        <div class="invalid-feedback">Vui lòng nhập loại vàng</div>
                    </div>
                    <div class="mb-3">
                        <label>Giá mua</label>
                        <input type="text" x-mask:dynamic="$money($input, '.', ',', 0)" x-ref="refBuyPrice" x-bind:disabled="IsBuyUpdating" class="form-control text-end autonumeric-input" x-model="BuyPrice" placeholder="VD: 7450000">
                    </div>
                    <div class="mb-3">
                        <label>Giá mua đang cập nhật</label>
                        <input type="checkbox" x-model="IsBuyUpdating">
                    </div>
                    <div class="mb-3">
                        <label>Giá bán</label>
                        <input type="text" x-mask:dynamic="$money($input, '.', ',', 0)" x-ref="SellPrice" x-bind:disabled="IsSellUpdating" class="form-control text-end autonumeric-input" x-model.lazy="SellPrice" placeholder="VD: 7500000">
                    </div>
                    <div class="mb-3">
                        <label>Giá bán đang cập nhật</label>
                        <input type="checkbox" x-model="IsSellUpdating">
                    </div>
                    <div class="mb-3">
                        <label>Sắp xếp</label>
                        <input type="number" x-ref="refSortOrder" class="form-control text-end autonumeric-input" x-model="SortOrder" placeholder="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" x-on:click="GoldPriceID = 0; GoldTypeName=''; BuyPrice=''; SellPrice=''; IsBuyUpdating=false; IsSellUpdating=false; $root.closeModal()">Đóng</button>
                    <button type="button" class="btn btn-primary" x-on:click="saveGoldType()">Lưu</button>
                </div>
            </div>
        </div>
    </div>
</div>

